<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#111827" />
  <title>四則練習</title>
  <link rel="manifest" href="manifest.webmanifest">
<style>
    :root { --bg:#0b1020; --card:#111827; --muted:#9ca3af; --text:#e5e7eb; --line:#243047; --btn:#2563eb; --btn2:#374151; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      background: linear-gradient(180deg, #050816, #0b1020 60%, #050816); color: var(--text); }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    h1 { font-size: 20px; margin: 6px 0 14px; letter-spacing:.5px; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 860px){ .grid { grid-template-columns: 360px 1fr; } }
    .card { background: rgba(17,24,39,.92); border:1px solid rgba(36,48,71,.9); border-radius: 16px; padding: 14px; box-shadow: 0 10px 22px rgba(0,0,0,.25); }
    .row { display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
    label { font-size: 13px; color: var(--muted); }
    input[type="number"]{ width: 88px; padding:10px 10px; border-radius:12px; border:1px solid var(--line); background:#0b1226; color:var(--text); outline:none; }
    input[type="text"]{ width: 140px; padding:12px 12px; border-radius:12px; border:1px solid var(--line); background:#0b1226; color:var(--text); outline:none; font-size:16px; }
    .btn { padding:11px 12px; border:none; border-radius:12px; background: var(--btn); color:white; font-weight:700; cursor:pointer; }
    .btn.secondary { background: var(--btn2); }
    .btn:disabled { opacity:.45; cursor:not-allowed; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; border:1px solid var(--line); background:#0b1226; color:var(--muted); font-size:13px; }
    .bigQ { font-size: 34px; font-weight: 900; letter-spacing: .5px; margin: 8px 0; }
    .muted { color: var(--muted); }
    .ok { color:#34d399; }
    .bad { color:#fb7185; }
    .warn { color:#fbbf24; }
    table { width:100%; border-collapse: collapse; font-size: 13px; }
    th, td { border-bottom: 1px solid rgba(36,48,71,.8); padding: 8px 6px; text-align:center; }
    th { color: var(--muted); font-weight: 700; }
    .hint { font-size: 12px; color: var(--muted); line-height: 1.5; }
    .spacer { height: 6px; }
    .right { margin-left:auto; }
    .switch { display:inline-flex; align-items:center; gap:8px; cursor:pointer; user-select:none; }
    .switch input{ transform: scale(1.1); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>四則練習</h1>

    <div class="grid">
      <!-- Settings -->
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="pill">設定</div>
          <button class="btn secondary" id="btnReset">清空紀錄</button>
        </div>

        <div class="spacer"></div>

        <div class="row">
          <div>
            <label>題數</label><br>
            <input type="number" id="count" min="1" max="500" value="10">
          </div>

          <div>
            <label>每題限時（秒）</label><br>
            <input type="number" id="timeLimit" min="1" max="120" value="5">
          </div>

          <div class="right">
            <label class="switch">
              <input type="checkbox" id="noLimit">
              不限時
            </label>
          </div>
        </div>

        <div class="row">
          <div>
            <label>位數1</label><br>
            <input type="number" id="digitsA" min="1" max="6" value="1">
          </div>
          <div>
            <label>位數2</label><br>
            <input type="number" id="digitsB" min="1" max="6" value="1">
        </div>

        <div class="row">
        <div>
            <label>運算類型</label><br>
            <label><input type="checkbox" id="opAdd" checked> +</label>
            <label><input type="checkbox" id="opSub" checked> -</label>
            <label><input type="checkbox" id="opMul" checked> ×</label>
            <label><input type="checkbox" id="opDiv" checked> ÷</label>
        </div>
      </div>
          </div>
          <div class="right">
            <label class="switch">
              <input type="checkbox" id="autoSave" checked>
              結算自動下載 CSV
            </label>
          </div>
        </div>

        <div class="row">
          <button class="btn" id="btnStart">開始</button>
          <button class="btn secondary" id="btnStop" disabled>停止 / 結算</button>
          <button class="btn secondary" id="btnDownload">下載 CSV</button>
        </div>

        <div class="hint">
          小提示：你可以把這頁「加到主畫面」當成 App。<br>
          紀錄會自動保存在本機（localStorage），關掉再開也還在。
        </div>
      </div>

      <!-- Game -->
      <div class="card">
        <div class="row">
          <div class="pill" id="progress">尚未開始</div>
          <div class="pill right" id="timer">倒數：-</div>
        </div>

        <div class="bigQ" id="question">請按「開始」</div>

        <div class="row">
          <label class="muted">答案：</label>
          <input type="text" id="answer" inputmode="numeric" placeholder="輸入後按 Enter" disabled>
          <button class="btn" id="btnSubmit" disabled>提交</button>
          <div class="pill right" id="feedback"> </div>
        </div>

        <div class="spacer"></div>

        <div class="pill" id="stats">答對：0｜答錯：0｜超時：0｜答對率：0.0%｜平均反應：-</div>

        <div class="spacer"></div>

        <div style="overflow:auto; border:1px solid rgba(36,48,71,.8); border-radius: 14px;">
          <table>
            <thead>
              <tr>
                <th>#</th><th>題目</th><th>你的答案</th><th>正確答案</th><th>結果</th><th>反應(秒)</th><th>時間</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // ---------- helpers ----------
  const $ = (id)=>document.getElementById(id);
  const pad2 = (n)=>String(n).padStart(2,'0');
  const nowStamp = ()=>{
    const d=new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  };
  const randInt = (lo,hi)=> Math.floor(Math.random()*(hi-lo+1))+lo;
  const randWithDigits = (d)=>{
    d = Number(d)||1;
    if (d<=1) return randInt(1,9);
    const lo = Math.pow(10, d-1);
    const hi = Math.pow(10, d) - 1;
    return randInt(lo, hi);
  };
  const round2 = (x)=> Math.round(x*100)/100;

  // ---------- state ----------
  let running=false;
  let total=10, idx=0;
  let a=null,b=null;
  let correctAns=null;
  let qText="";
  let correct=0, wrong=0, timeout=0;

  let noLimit=false;
  let timeLimit=5;
  let remaining=0;
  let timerHandle=null;
  let qStartMs=0;

  let records=[]; // persist in localStorage
  const LS_KEY = "multiply_game_records_v1";

  function loadRecords(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      records = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(records)) records=[];
    }catch(e){ records=[]; }
  }
  function saveRecords(){
    try{ localStorage.setItem(LS_KEY, JSON.stringify(records)); }catch(e){}
  }

  function setFeedback(text, cls){
    const el=$("feedback");
    el.textContent = text || " ";
    el.className = "pill right " + (cls||"");
  }

  function updateStats(){
    const done = correct+wrong+timeout;
    const acc = done ? (correct/done*100) : 0;
    const times = records.map(r=>r.reaction_sec).filter(x=>typeof x==="number" && isFinite(x));
    const avg = times.length ? (times.reduce((s,x)=>s+x,0)/times.length) : null;
    $("stats").textContent = `答對：${correct}｜答錯：${wrong}｜超時：${timeout}｜答對率：${acc.toFixed(1)}%｜平均反應：${avg===null? "-" : avg.toFixed(2)+"s"}`;
  }

  function renderTable(){
    const tb=$("tbody");
    tb.innerHTML="";
    for(const r of records){
      const tr=document.createElement("tr");
      const reactionText = (typeof r.reaction_sec==="number") ? r.reaction_sec.toFixed(2) : "-";
      tr.innerHTML = `
        <td>${r.idx}</td>
        <td>${r.question}</td>
        <td>${r.user_answer}</td>
        <td>${r.correct_answer}</td>
        <td class="${r.result==='正確'?'ok':(r.result==='錯誤'?'bad':'warn')}">${r.result}</td>
        <td>${reactionText}</td>
        <td>${r.timestamp}</td>
      `;
      tb.appendChild(tr);
    }
  }

  function cancelTimer(){
    if(timerHandle){ clearInterval(timerHandle); timerHandle=null; }
  }

function startTimer(){
  cancelTimer();
  if(noLimit) {
    $("timer").textContent = "不限時";
    return;
  }

  $("timer").textContent = `倒數：${remaining} 秒`;
  timerHandle = setInterval(() => {
    if(!running){               // ✅ 停止/結算後才停計時
      cancelTimer();
      return;
    }
    remaining -= 1;

    if(remaining <= 0){
      $("timer").textContent = "倒數：0 秒";
      cancelTimer();
      onTimeout();
      return;
    }
    $("timer").textContent = `倒數：${remaining} 秒`;
  }, 1000);
}}

  function nextQuestion(){
    if(idx >= total){
      finishGame(true);
      return;
    }
    idx += 1;
    const da = Number($("digitsA").value) || 1;
    const db = Number($("digitsB").value) || 1;
    const ops = [
  $("opAdd")?.checked ? "+" : null,
  $("opSub")?.checked ? "-" : null,
  $("opMul")?.checked ? "*" : null,
  $("opDiv")?.checked ? "/" : null,
].filter(Boolean);

const op = ops.length ? ops[randInt(0, ops.length - 1)] : "*";
console.log("checked ops =", ops, "chosen =", op);

if(op === "+"){
  a = randWithDigits(da);
  b = randWithDigits(db);
  correctAns = a + b;
  qText = `${a} + ${b}`;
}
else if(op === "-"){
  a = randWithDigits(da);
  b = randWithDigits(db);
  if(b > a) [a, b] = [b, a];   // 避免負數
  correctAns = a - b;
  qText = `${a} - ${b}`;
}
else if(op === "*"){
  a = randWithDigits(da);
  b = randWithDigits(db);
  correctAns = a * b;
  qText = `${a} × ${b}`;
}
else if(op === "/"){
  b = randWithDigits(db);
  const q = randWithDigits(da);
  a = b * q;                  // 保證整除
  correctAns = q;
  qText = `${a} ÷ ${b}`;
}
else{
  // 保底：萬一 op 不明，就用乘法
  a = randWithDigits(da);
  b = randWithDigits(db);
  correctAns = a * b;
  qText = `${a} × ${b}`;
}

$("progress").textContent = `第 ${idx} / ${total} 題`;
$("question").textContent = `${qText} = ?`;
    $("answer").value = "";
    $("answer").focus();
    setFeedback("", "");
remaining = Math.max(1, Number($("seconds").value) || 5);

qStartMs = Date.now();  // ← 建議先記開始時間

if(noLimit){
  cancelTimer();                 // ⭐ 保險：避免舊 timer 還在跑
  $("timer").textContent = "不限時";
}else{
  startTimer();
}


  function appendRecord(userAnswer, result){
  const rt = (qStartMs ? (Date.now()-qStartMs)/1000 : null);

  const rec = {
    idx: records.length + 1,
    a, b,
    question: qText,                    // ✅ 四則題目字串
    user_answer: userAnswer,
    correct_answer: String(correctAns), // ✅ 四則正解
    result,
    reaction_sec: (typeof rt==="number" && isFinite(rt)) ? round2(rt) : null,
    timestamp: nowStamp(),
  };

  records.push(rec);
  saveRecords();
  renderTable();
}

  function onTimeout(){
    cancelTimer();
    timeout += 1;
    setFeedback(`⏱ 超時！正解 ${correctAns}`, "warn");
    appendRecord("(超時)", "超時");
    updateStats();
    setTimeout(nextQuestion, 700);
  }

  function submit(){
  if(!running) return;
  if(!noLimit) cancelTimer();

  const text = $("answer").value.trim();
  if(!/^-?\d+$/.test(text)){
    setFeedback("請輸入整數", "warn");
    if(!noLimit){
      remaining = Math.max(remaining, 1);
      startTimer();
    }
    return;
  }

  const userVal = parseInt(text,10);
  const correctAnsLocal = correctAns;   // ✅ 這裡用全域 correctAns

  if(userVal === correctAnsLocal){
    correct += 1;
    setFeedback("✅ 正確！", "ok");
    appendRecord(String(userVal), "正確");
  }else{
    wrong += 1;
    setFeedback(`❌ 錯誤！正解 ${correctAnsLocal}`, "bad");
    appendRecord(String(userVal), "錯誤");
  }

  updateStats();
  setTimeout(nextQuestion, 500);
}

  function toCSV(){
    const headers = ["序號","題目","被乘數","乘數","你的答案","正確答案","結果","反應秒數","時間戳記"];
    const lines = [headers.join(",")];
    for(const r of records){
      const row = [
        r.idx,
        r.question,
        r.a,
        r.b,
        r.user_answer,
        r.correct_answer,
        r.result,
        (typeof r.reaction_sec==="number") ? r.reaction_sec : "",
        r.timestamp
      ].map(v=>{
        const s = String(v??"");
        // escape CSV
        if(s.includes('"') || s.includes(",") || s.includes("\n")){
          return `"${s.replaceAll('"','""')}"`;
        }
        return s;
      });
      lines.push(row.join(","));
    }
    // UTF-8 BOM for Excel-friendly Chinese
    return "\uFEFF" + lines.join("\n");
  }

  function downloadCSV(filename){
    const blob = new Blob([toCSV()], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 500);
  }

  function finishGame(auto){
    if(!running) return;
    running=false;
    cancelTimer();

    $("btnStart").disabled=false;
    $("btnStop").disabled=true;
    $("btnSubmit").disabled=true;
    $("answer").disabled=true;

    $("progress").textContent = "遊戲結束";
    $("question").textContent = "已結束";
    $("timer").textContent = noLimit ? "不限時" : "倒數：-";

    const done = correct+wrong+timeout;
    const acc = done ? (correct/done*100) : 0;

    if($("autoSave").checked){
      const name = `乘法練習紀錄_${new Date().toISOString().slice(0,19).replaceAll(":","").replace("T","_")}.csv`;
      // 結算自動下載（不跳任何視窗）
      downloadCSV(name);
      setFeedback("已自動下載 CSV ✅", "ok");
    }else{
      setFeedback(`結算完成（答對率 ${acc.toFixed(1)}%）`, "");
    }
    updateStats();
  }

  function startGame(){
    // read settings
    total = Number($("count").value)||10;
    timeLimit = Number($("timeLimit").value)||5;
    noLimit = $("noLimit").checked;

    if(total<=0){ alert("題數必須 > 0"); return; }
    if(!noLimit && timeLimit<=0){ alert("限時秒數必須 > 0（或勾選不限時）"); return; }

    running=true;
    idx=0;
    correct=wrong=timeout=0;

    $("btnStart").disabled=true;
    $("btnStop").disabled=false;
    $("btnSubmit").disabled=false;
    $("answer").disabled=false;

    updateStats();
    nextQuestion();
  }

  function resetRecords(){
    if(running){
      alert("遊戲進行中不能清空。請先停止/結算。");
      return;
    }
    if(!confirm("確定要清空所有歷史紀錄？（會刪除本機保存）")) return;
    records=[];
    saveRecords();
    renderTable();
    correct=wrong=timeout=0;
    updateStats();
    setFeedback("已清空紀錄", "");
  }

  // ---------- bind ----------
  $("btnStart").addEventListener("click", startGame);
  $("btnStop").addEventListener("click", ()=>finishGame(false));
  $("btnSubmit").addEventListener("click", submit);
  $("answer").addEventListener("keydown", (e)=>{ if(e.key==="Enter") submit(); });

  $("btnDownload").addEventListener("click", ()=>{
    if(records.length===0){ alert("目前沒有紀錄可下載"); return; }
    const name = `乘法練習紀錄_${new Date().toISOString().slice(0,19).replaceAll(":","").replace("T","_")}.csv`;
    downloadCSV(name);
  });

  $("btnReset").addEventListener("click", resetRecords);

  $("noLimit").addEventListener("change", ()=>{
    const on = $("noLimit").checked;
    $("timeLimit").disabled = on;
    if(on){
      noLimit=true;
      cancelTimer();
      $("timer").textContent = "不限時";
    }else{
      noLimit=false;
      $("timer").textContent = "倒數：-";
    }
  });

  // init
  loadRecords();
  renderTable();
  updateStats();
  $("timeLimit").disabled = $("noLimit").checked;
})();
</script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js');
}
</script>
</body>
</html>



